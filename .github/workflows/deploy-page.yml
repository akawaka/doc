name: Build and deploy to GitHub Pages

on:
    push:
        branches: [ master, main ]
    workflow_dispatch:

jobs:
    build:
        runs-on: ubuntu-latest
        steps:
            -   name: Checkout source
                uses: actions/checkout@v4
                with:
                    fetch-depth: 2
            -   name: Setup PHP
                uses: shivammathur/setup-php@v2
                with:
                    php-version: '8.3'
                    tools: composer
                    extensions: mbstring, gd, imagick, intl, gettext
            - name: Install or update Composer deps
              run: |
                  set -e
                  if git diff --quiet HEAD^ -- composer.json composer.lock 2>/dev/null; then
                      echo "composer.json/lock unchanged → install"
                      composer install --no-interaction --no-progress --prefer-dist
                  else
                      echo "composer.json/lock changed → update"
                      composer update --no-interaction --no-progress --prefer-dist
                  fi
            -   name: Build site with Cecil
                uses: Cecilapp/Cecil-Action@v3
                with:
                    args: '-vv --clear-cache --optimize'
            -   name: Upload artifact
                uses: actions/upload-pages-artifact@v3
    deploy:
        needs: build
        permissions:
            pages: write
            id-token: write
        concurrency:
            group: pages
            cancel-in-progress: true
        environment:
            name: github-pages
            url: ${{ steps.deployment.outputs.page_url }}
        runs-on: ubuntu-latest
        steps:
            -   name: Deploy to GitHub Pages
                id: deployment
                uses: actions/deploy-pages@v4
